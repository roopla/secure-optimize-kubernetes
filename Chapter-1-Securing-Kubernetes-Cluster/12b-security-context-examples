step #1 Normal pod - normalpod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: regular-pod-demo
spec:
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: regular-demo
    image: docker.io/redhat/ubi8
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo


kubectl apply -f normalpod.yaml
Go inside the pod and execute:
id
capsh --print
ls -l /data
su -
yum install nmap-ncat
rm -rf /*


Step #2 - secure pod - securepod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: non-privileged-pod-demo
spec:
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: non-privileged-demo
    image: docker.io/redhat/ubi8
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo
    securityContext:
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL


kubectl apply -f securepod.yaml
Go inside the pod and execute:
id
capsh --print
ls -l /data
su -
yum install nmap-ncat
rm -rf /*


Step #3 - Secure pod with non-root user - secure-non-root-pod.yaml
Some applications are configured to run as root

apiVersion: v1
kind: Pod
metadata:
  name: non-root-user-pod-demo
spec:
  securityContext:
    runAsNonRoot: true
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: non-root-user-demo
    image: docker.io/demisto/iputils:1.0.0.62867
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo
    securityContext:
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

kubectl apply -f secure-non-root-pod.yaml
kubectl get pods/runasnonroot-pod-demo -ojson | jq .status.containerStatuses



Step #4 - Secure non-root with specific user/group - secure-user-group-pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: non-root-user-pod-demo
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: non-root-user-demo
    image: docker.io/demisto/iputils:1.0.0.62867
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo
    securityContext:
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

kubectl apply -f secure-user-group-pod.yaml

Go inside the pod
id
touch /alok
touch /data/demo/aa
ping google.com


Step #5 - Specific Capability - specific-power.yaml

apiVersion: v1
kind: Pod
metadata:
  name: capability-pod-demo
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: capability-demo
    image: demisto/iputils:1.0.0.62867
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo
    securityContext:
      privileged: false
      allowPrivilegeEscalation: true
      capabilities:
        drop:
          - ALL
        add:
         - NET_RAW

kubectl apply -f specific-power.yaml
Go inside the container - kubectl exec -it pod-name -- sh
ping google.com

Step #6 - Read only filesystem - readonly-pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: read-only-root-fs-pod-demo
spec:
  containers:
  - name: read-only-root-fs-demo
    image: docker.io/redhat/ubi8
    command: [ "tail", "-f", "/dev/null" ]
    securityContext:
      readOnlyRootFilesystem: true


kubectl apply -f readonly-pod.yaml
Go inside the pod - kubectl exec -it pod-name -- sh

touch alok
